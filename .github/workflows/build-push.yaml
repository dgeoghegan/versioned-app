name: build-and-push

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  
permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: 557690605702.dkr.ecr.us-east-1.amazonaws.com
  ECR_REPOSITORY: versioned-app
  IMAGE_NAME: versioned-app

jobs:
  build_push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print GitHub OIDC context
        shell: bash
        run: |
          echo "GITHUB_REPOSITORY=${GITHUB_REPOSITORY}"
          echo "GITHUB_REF=${GITHUB_REF}"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
          retry-max-attempts: 2

      - name: Verify assumed identity
        shell: bash
        run: |
          set -euo pipefail
          aws sts get-caller-identity

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Compute tags
        id: tags
        shell: bash
        run: |
          set -euo pipefail
          SHORT_SHA="${GITHUB_SHA:0:12}"
          SHA_TAG="sha-${SHORT_SHA}"
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "sha_tag=${SHA_TAG}" >> "$GITHUB_OUTPUT"

          # capture semver tag name (e.g. v0.1.1) if this is a git tag push
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            SEMVER_TAG="${GITHUB_REF#refs/tags/}"
            echo "semver_tag=${SEMVER_TAG}" >> "$GITHUB_OUTPUT"
          else
            echo "semver_tag=" >> "$GITHUB_OUTPUT"
          fi

      - name: Build
        shell: bash
        run: |
          set -euo pipefail
          IMAGE_URI="${ECR_REGISTRY}/${ECR_REPOSITORY}"
          docker build -t "${IMAGE_URI}:${{ steps.tags.outputs.sha_tag }}" .

      - name: Push immutable SHA tag (skip if exists)
        shell: bash
        run: |
          set -euo pipefail
          IMAGE_URI="${ECR_REGISTRY}/${ECR_REPOSITORY}"
          TAG="${{ steps.tags.outputs.sha_tag }}"

          if aws ecr describe-images \
              --repository-name "${ECR_REPOSITORY}" \
              --image-ids imageTag="${TAG}" \
              --region "${AWS_REGION}" >/dev/null 2>&1; then
            echo "ECR tag ${TAG} already exists; skipping push."
          else 
            docker push "${IMAGE_URI}:${TAG}"
          fi

      - name: Also tag + push semver (only on tag pushes)
        if: ${{ steps.tags.outputs.semver_tag != '' }}
        shell: bash
        run: |
          set -euo pipefail
          IMAGE_URI="${ECR_REGISTRY}/${ECR_REPOSITORY}"
          docker tag "${IMAGE_URI}:${{ steps.tags.outputs.sha_tag }}" "${IMAGE_URI}:${{ steps.tags.outputs.semver_tag }}"
          docker push "${IMAGE_URI}:${{ steps.tags.outputs.semver_tag }}"

      # Trigger bump workflow in gitops-release-controller (requires a token with access to that repo)
      - name: Dispatch bump-dev-image to gitops-release-controller
        if: ${{ github.ref == 'refs/heads/main' }}
        shell: bash
        env:
          DISPATCH_TOKEN: ${{ secrets.GITOPS_REPO_DISPATCH_TOKEN }}
          TARGET_REPO: dgeoghegan/gitops-release-controller
          IMAGE_TAG: ${{ steps.tags.outputs.sha_tag }}
          SHORT_SHA: ${{ steps.tags.outputs.short_sha }}
        run: |
          set -euo pipefail

          # Fail fast with readable output
          if [[ -z "${DISPATCH_TOKEN}" ]]; then
            echo "Missing DISPATCH_TOKEN"
            exit 1
          fi
          if [[ -z "${TARGET_REPO}" ]]; then
            echo "Missing TARGET_REPO"
            exit 1
          fi

          # TARGET_REPO must be exactly OWNER/REPO (no URL, no spaces)
          TARGET_REPO="$(echo -n "${TARGET_REPO}" | tr -d '\r\n' | xargs)"
          if [[ ! "${TARGET_REPO}" =~ ^[A-Za-z0-9_.-]+/[A-Za-z0-9_.-]+$ ]]; then
            echo "Invalid TARGET_REPO format: [${TARGET_REPO}] (expected OWNER/REPO)"
            exit 1
          fi

          API="https://api.github.com/repos/${TARGET_REPO}/dispatches"
          REPO_URL="https://api.github.com/repos/${TARGET_REPO}"
          echo "Dispatching to ${API}"

          REPO_CHECK=$(curl -sS -o /dev/null -w "%{http_code}" \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${DISPATCH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "${REPO_URL}")

          echo "repo_check=${REPO_CHECK}"
          if [[ "${REPO_CHECK}" != "200" ]]; then
            echo "Token cannot read repo (or repo name wrong). Fix PAT permissions / repo access."
            exit 1
          fi 

          curl -sSf -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${DISPATCH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "${API}" \
            -d "{\"event_type\":\"bump-dev-image\",\"client_payload\":{\"image_tag\":\"${IMAGE_TAG}\",\"git_sha\":\"${SHORT_SHA}\"}}"
